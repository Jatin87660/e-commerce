<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>home</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  </head>
  <body>

    <div class="d-flex justify-content-between mt-5">
        <h2 class="ms-5">Items</h2>
        <div class="me-5">
            <button class="btn btn-primary checkout">CheckOut</button>
            <button onclick="show_cart()" class="btn btn-secondary">Cart</button>
            <button class="btn btn-secondary" onclick="show_order_history()">Order History</button>
        </div>
    </div>
    <div class="d-flex">
        <% items.forEach(item => { %>
            <div class="border m-5">
                <strong>Name:</strong> <%= item.name %> <br>
                <strong>Amount:</strong> <%= item.amount %><br>
                <button class="btn btn-secondary w-100 mt-2 add-to-cart" data-id="<%= item._id %>">Add to cart</button>

            </div>
            <% }) %>
    </div>

    <!-- cart pop up -->

    <div id ="cart" class="position-fixed top-50 start-50 translate-middle bg-white p-4 rounded shadow d-none" 
     style="max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; z-index: 1050;">
  <h2>Your Cart</h2>

  <% if (cart_items.length === 0) { %>
    <div class="alert alert-info">Your cart is empty.</div>
  <% } else { %>

    <table class="table table-bordered mt-3">
      <thead>
        <tr>
          <th>Item</th>
          <th>Price</th>
        </tr>
      </thead>

      <tbody>
        <% cart_items.forEach(item => { %>
          <tr>
            <td><%= item.name %></td>
            <td>₹<%= item.amount %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>

    <h4>Total: ₹<%= total %></h4>
  <% } %>
  <div class="d-flex justify-content-center mt-3">
  <button id="close_cart" class="btn btn-primary" onclick="hide_cart()">Close cart</button>
</div>
<!-- orders -->
</div>

<div id ="orders" class="position-fixed top-50 start-50 translate-middle bg-white p-4 rounded shadow d-none " 
     style="max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; z-index: 1050;">
  <h2>Your Order Succesfully Placed</h2>

  <% if (order_items.length === 0) { %>
    <div class="alert alert-info">There is no order.</div>
  <% } else { %>

    <table class="table table-bordered mt-3">
      <thead>
        <tr>
          <th>Item</th>
          <th>Price</th>
        </tr>
      </thead>

      <tbody>
        <% order_items.forEach(item => { %>
          <tr>
            <td><%= item.name %></td>
            <td>₹<%= item.amount %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>

    <h4>Total: ₹<%= amount %></h4>
  <% } %>
  <div class="d-flex justify-content-center mt-3">
  <button id="close_order" class="btn btn-primary" onclick="hide_order()">Close Order</button>
</div>

</div>


<!-- order history form -->

<div id ="order_history" class="position-fixed top-50 start-50 translate-middle bg-white p-4 rounded shadow  d-none" 
     style="max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; z-index: 1050;">
  <h2>Your Order History</h2>

  <% if (order_history.length === 0) { %>
  <div class="alert alert-info">There are no orders.</div>
<% } else { %>
  <% order_history.forEach(order => { %>
    <div>
      <strong>Order placed on  <%= order.createdAt.toLocaleString() %></strong><br>
      <!-- <% order.items.forEach(item => { %> -->
        <span>Order Id : <%= order._id %></span><br>
        <span>Amount : <strong><%= order.amount %></strong></span><br><br>
      <!-- <% }) %> -->
    </div>
  <% }) %>
<% } %>
  <div class="d-flex justify-content-center mt-3">
  <button id="close_order_history" class="btn btn-primary" onclick="hide_order_history()">Close Order</button>
</div>

</div>

    

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <script>
document.querySelectorAll(".add-to-cart").forEach(button => {
  button.addEventListener("click", () => {
    const itemId = button.dataset.id;

    fetch("/carts", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ itemId })
    })
    .then(res => res.json())
    .then(data => {
      window.location.reload();
      alert(data.message);
    })
    .catch(err => {
      console.error(err);
      alert("Error adding item to cart");
    });
  });
});

//checkout

document.querySelectorAll(".checkout").forEach(button => {
  button.addEventListener("click", () => {

    fetch("/orders", { method: "POST" })
      .then(res => res.json())
      .then(data => {
        if (data.message === "Order placed successfully") {
          // Set flag before reload
          localStorage.setItem("showOrders", "true");
          window.location.reload();
        } else {
          alert("Something went wrong");
        }
      })
      .catch(err => {
        console.error(err);
        alert("Error placing order");
      });

  });
});

// On page load, check the flag
window.addEventListener("DOMContentLoaded", () => {
  if (localStorage.getItem("showOrders") === "true") {
    const ordersDiv = document.getElementById("orders");
    if (ordersDiv) {
      ordersDiv.classList.remove("d-none");
    }
    // Remove the flag so it only triggers once
    localStorage.removeItem("showOrders");
  }
});




function show_cart(){
  document.getElementById('cart').classList.remove('d-none');
}

function hide_cart(){
  document.getElementById('cart').classList.add('d-none');
}


function hide_order(){
  document.getElementById('orders').classList.add('d-none');
}



function show_order_history(){
  document.getElementById('order_history').classList.remove('d-none');
}

function hide_order_history(){
  document.getElementById('order_history').classList.add('d-none');
}
</script>

  </body>
</html>
